---
title: "GLMs for field data"
author: "Sandra Emry"
date: "10/11/2021"
output: html_document
---

```{r set chunk options, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE)

knitr::opts_chunk$set(out.width = "80%") 
```


```{r load packages and create functions, include = FALSE, eval = TRUE}
library(skimr)
library(cowplot)
library(visreg)
library(tidyverse)
library(broom)
library(broom.mixed)
library(dotwhisker)
library(rcompanion)
library(effects)
library(xtable)
library(lme4)
library(emmeans)
library(here)
library(glmmTMB)
library(bbmle) 
library(visdat)
library(patchwork)
library(DHARMa)
library(car)

# set a ggplot theme for all plots
theme_set(ggpubr::theme_pubr() + theme(axis.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
      legend.key = element_blank(), 
       legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       legend.text = element_text(size = 9, colour = "grey30")))

CLDs_to_plot <- function(model_name){
  
  grp_means_log <- emmeans(model_name, 
                           specs = pairwise ~ month : salinity_regime, 
                           data = survey_data)
  
  grp_means_log.df <- summary(grp_means_log$contrasts)
  
  grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
  letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 
  
  letters$salinity_regime <- "L"
  letters$salinity_regime[str_detect(letters$Group, "H")] <- "H"
  
  letters$month <- "May"
  letters$month[str_detect(letters$Group, "June")] <- "June"
  letters$month[str_detect(letters$Group, "July")] <- "July"
  letters$month[str_detect(letters$Group, "September")] <- "September"
  
  letters_to_plot <<- letters 
  
}

CLDs_to_plot_exp <- function(model_name){
  
  grp_means_log <- emmeans(model_name, 
                           specs = pairwise ~ treatment : region, 
                           data = survey_data)
  
  grp_means_log.df <- summary(grp_means_log$contrasts)
  
  grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
  letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 
  
  letters$region <- "Low"
  letters$salinity_regime[str_detect(letters$Group, "High")] <- "High"
  
  letters$treatment <- "control"
  letters$month[str_detect(letters$Group, "exclusion")] <- "exclusion"
  
  letters_to_plot <<- letters 
  
}

```
## Field survey data
Using the package glmmTMB to model groups of species individually. 

```{R Field: load and prep data, eval = TRUE}
survey_data <- read_csv(here::here("data", "tidy", "field_transect_tidy.csv"))

survey_data <- survey_data %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         site = factor(site, levels = c("Horseshoe Bay", "Rope Site 2", "Lions Bay 2", "Ruckle", "Eagle Cove", "Hailstorm 2")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))
  
knitr::kable(head(survey_data), caption = "The first 6 rows of the dataset")

cols = c("L" = "orange", "H" = "steelblue")

# prep anova table to hold stats for all taxa
survey_anova_table <- data.frame(taxon = character(), 
           Factor = character(),
           Df = double(),
           `X2 value` = double(),
           `Pr(>|ChiX2|)` = double())

survey_anova_table$taxon <- c()
```
**Models fit to the data:**  
1.  Zero-inflated Poisson model with a single zero-inflation parameter by applying to all observations (`ziformula~1`)  
2.  Zero-inflated Negative Binomial model with NB2 parameterization (variance = $\mu$(1 + $\mu$/$\kappa$), increasing quadratically with the mean)    
3. Zero-inflated Negative Binomial model with NB1 parameterization (variance = $\mu$ + $\phi$$\mu$, increasing linearly with the mean)  
4. Poisson model  
5. Tweedie model  
6. Gaussian model  
7. Negative Binomial with NB2 parameterization  
8. Negative Binomial with NB1 parameterization
9. For percent cover data, I transformed data so that it was bound between 0 and 1 and modelled it with a beta distribution. (Balanus & Chthamalus in the survey data, and algae in both datasets).

### Gastropods

#### Limpets
Because there are so many 'unknown limpets' I'm lumping all species together.  
```{R Survey Limpets: inital plots, fig.cap = "Abundance of different limpet species in survey dataset", fig.height = 4, fig.width = 9}
survey_data %>% pivot_longer(cols = c("paradigitalis_no", "unknown_limpet_no", "pelta_no", "scutum_no", "persona_no", "digitalis_no", "all_limpets_no"), names_to = "species", values_to = "counts") %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = species, y = log(counts + 1)))


# ggplot(data = limpets_data) + geom_boxplot(aes(x = month, y = log(all_limpets_no+1), fill = salinity_regime))
# ggplot(data = limpets_data) + geom_boxplot(aes(x = month, y = all_limpets_no, fill = salinity_regime))
# 
# ggplot(data = limpets_data) + 
#   geom_point(aes(x = month, y = all_limpets_no)) + 
#   facet_wrap(~site, scales = "free")
```

Fitting the models, and using AIC to select best model for the data:
```{R Survey Limpets: models, echo = TRUE, eval = TRUE}

limpet_zipoisson <- glmmTMB(all_limpets_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

limpet_ziNB <- update(limpet_zipoisson, family = nbinom2)

limpet_ziNB1 <- update(limpet_zipoisson, family = nbinom1) # best model 

limpet_poisson <-  glmmTMB(all_limpets_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

limpet_tweedie <- glmmTMB(all_limpets_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

limpet_gaussian <- glmmTMB((all_limpets_no + 1) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

limpet_NB <- update(limpet_poisson, family = nbinom2)

limpet_NB1 <- update(limpet_poisson, family = nbinom1)

```

**Model Comparison**
```{r Survey Limpets: model selection and checking assumptions, eval = TRUE}

AICtab(limpet_zipoisson, limpet_ziNB, limpet_ziNB1, limpet_poisson, limpet_NB, limpet_NB1, limpet_tweedie, limpet_gaussian)  %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

#checking assumptions 
limpet_sim_res <- simulateResiduals(limpet_ziNB1)
plot(limpet_sim_res)

par(mfrow = c(1,2))
# plot residuals against time
plotResiduals(limpet_sim_res, form = survey_data$month)
plotResiduals(limpet_sim_res, form = survey_data$salinity_regime) # greater variance in the high salinity sites 

```  

Adding a dispersion formula for salinity regime to account for heterogeneity
```{R Survey Limpets: refining the model, echo = TRUE, eval = TRUE}
limpet_ziNB1_2 <- glmmTMB(all_limpets_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, dispformula = ~salinity_regime, family = nbinom1)

#checking assumptions 
limpet_sim_res_2 <- simulateResiduals(limpet_ziNB1_2)
plotResiduals(limpet_sim_res_2, form = survey_data$salinity_regime) # good

```  
  
Limpet model output: 
Salinity regime and the interaction with month are significant.  
```{R Survey Limpets: model output, eval = TRUE}

# parameters
coef <- summary(limpet_ziNB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to limpet survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(limpet_ziNB1_2, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to limpet survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

limpet_anova_table <- car::Anova(limpet_ziNB1_2, type = "III") %>% 
  tidy() 

limpet_anova_table$taxa <- rep("limpets", nrow(limpet_anova_table))

limpet_anova_table <- limpet_anova_table %>% 
  relocate(taxa, .before = source)

grp_means_log <- emmeans(limpet_ziNB1_2, specs = pairwise ~ month | salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to limpet survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```


```{R Survey Limpets: final plot, fig.cap = "limpet abundance from transects in high and low salinity sites over the summer"}
col_text <- c("L" = "black", "H" = "black")

CLDs_to_plot(limpet_ziNB1_2)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(all_limpets_no + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = c("salinity_regime", "month"))

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_limpets_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(all_limpets_no+1), fill = salinity_regime), position = "dodge") +
  labs(y = "abundance (log + 1)", x = "month", title = "limpets") + 
  scale_fill_manual(values = cols) + 
  theme(legend.position = "none") + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5),  vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(all_limpets_no+1), fill = salinity_regime)) +
  labs(y = "limpet abundance (log + 1)", x = "month") + 
  scale_fill_manual(values = cols) + 
  theme(legend.position = "none") + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5),  vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_limpets.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
  
```

#### Littorines
*littorina* spp, *sitkana*, and *littorina* total  
I'm using total littorines since the maximum number of *sitkana* is much lower and it's mostly just Horseshoe Bay that has *sitkana*.
```{R Survey Littorines: initial plots, fig.show="hold", out.width="50%"}
par(mfrow = c(1,2))
survey_data %>% pivot_longer(cols = c("littorina_spp_no", "sitkana_no", "littorina_total_no"), names_to = "species", values_to = "counts") %>% ggplot(data = .) + geom_boxplot(aes(x = species, y = log(counts+1)))

hist(survey_data$littorina_total_no, breaks = seq(0, max(survey_data$littorina_total_no), by = 100))

```

```{R Survey Littorines: models, echo = TRUE}

littorine_zipoisson <- glmmTMB(littorina_total_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

littorine_ziNB <- update(littorine_zipoisson, family = nbinom2)

littorine_ziNB1 <- update(littorine_zipoisson, family = nbinom1)

littorine_poisson <-  glmmTMB(littorina_total_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

littorine_gaussian <-  glmmTMB((littorina_total_no+1) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

littorine_tweedie <- update(littorine_poisson, family = tweedie)

littorine_NB <- update(littorine_poisson, family = nbinom2)

littorine_NB1 <- update(littorine_poisson, family = nbinom1)

```  

Littorine model selection using AIC. The best model is the one using a negative binomial distribution, without modelling the zeroes. I needed to add a dispersion formula to model the variance in each salinity region separately.  
```{R Survey Littorines: model selection and checking assumptions}
## Model comparison
AICtab(littorine_zipoisson, littorine_ziNB, littorine_ziNB1, littorine_poisson, littorine_NB, littorine_NB1, littorine_gaussian, littorine_tweedie) # best model is the negative binomial without zero-inflation

#checking assumptions 
set.seed(900)
littorine_sim_res <- simulateResiduals(littorine_NB1)
plot(littorine_sim_res)

par(mfrow = c(1,2))
# plot residuals against time
plotResiduals(littorine_sim_res, form = survey_data$month)
#plot residuals against salinity regime
plotResiduals(littorine_sim_res, form = survey_data$salinity_regime) # more variance in the low salinity sites

```   

Adding a dispersion formula to account for heterogeneity in the high and low salinity regions.  
```{R Survey Littorines: refining the model, echo = TRUE}

# adding in a dispersion formula to account for unequal varaince between regions
littorine_NB1_2 <- glmmTMB(littorina_total_no ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, dispformula = ~salinity_regime*month, family = nbinom1)

#checking assumptions 
set.seed(900)
littorine_sim_res_2 <- simulateResiduals(littorine_NB1_2)

plotResiduals(littorine_sim_res_2, form = survey_data$salinity_regime) # better
plotResiduals(littorine_sim_res_2, form = survey_data$month) # better

```

**Littorine model output:** 
```{R Survey Littorines: model output}
# parameters
coef <- summary(littorine_NB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to littorine survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(littorine_NB1_2, type = "III") %>% 
  tidy() %>% 
  filter(term != '(Intercept)') %>% 
  kableExtra::kable(caption = "p values for model fitted to littorine survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

littorines_anova_table <- car::Anova(littorine_NB1_2, type = "III") %>% 
  tidy()

grp_means_log <- emmeans(littorine_NB1_2, specs = pairwise ~ month | salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to littorine survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Survey Littorines: final plot, fig.cap = "Littorine abundance from transect data in high and low salinity sites over the summer"}

CLDs_to_plot(littorine_NB1_2)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(littorina_total_no + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = c("salinity_regime", "month"))

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_littorines_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(littorina_total_no+1), fill = salinity_regime)) +
  labs(y = "abundance (log + 1)", x = "month", title = "littorines") + 
    scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "left",
    legend.margin = margin(6, 6, 6, 6)
    ) +
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(littorina_total_no+1), fill = salinity_regime)) +
  labs(y = "littorine abundance (log + 1)", x = "month") + 
    scale_fill_manual(values = cols) + 
    geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_littorines.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

### Barnacles
species: *Balanus*, *Chthalamus*, recruits and total  
```{R Survey Barnacle: plots, out.width = "100%"}

a <- survey_data %>% pivot_longer(cols = c("balanus_pt", "chthamalus_pt", "barnacle_recruits_pt", barnacles_total_pt), names_to = "species", values_to = "percent_cover") %>% mutate(species = str_replace_all(species, c("_pt" = "", "barnacles_" = "", "barnacle_" = ""))) %>%  
  ggplot(data = .) + 
  geom_boxplot(aes(x = species, y = percent_cover)) + 
  theme(axis.text = element_text(size = 10))  

b <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(balanus_pt + 1), fill = salinity_regime)) # looks like variance increases with time

c <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(chthamalus_pt + 1), fill = salinity_regime)) # very few chthamalus in the low salinity sites 

d <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = barnacle_recruits_pt, fill = salinity_regime))

par(mfrow = c(2,2))
a + b + c + d
```

#### Balanus models
For percent cover data, I'm rounding to nearest integer.  
Not including an interaction term for barnacles
Best model is *negative binomial* distribution
```{R Survey Balanus: models, echo = TRUE}

# balanus_poisson <- glmmTMB(round(balanus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))
# 
# balanus_NB <- update(balanus_poisson, family = nbinom2) 
# 
# balanus_NB1 <- update(balanus_poisson, family = nbinom1) #best model 

# convert to between 0 and 1 for beta model

survey_data %>% 
  group_by(site, month) %>% tally()
n <- 8
s <- 0.1

survey_data <- survey_data %>% 
  mutate(balanus_beta = ((balanus_pt/100)*(n-1) + s)/n)

balanus_beta <- glmmTMB(balanus_beta ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = beta_family(link = "logit")) 

# balanus_NB1 <- glmmTMB(round(balanus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = nbinom1) #best model
# 
# balanus_gaussian <- glmmTMB((balanus_pt+1) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))
# 
# balanus_tweedie <- glmmTMB(balanus_pt ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))
# 
# # models with zero-inflation
# balanus_zipoisson <- glmmTMB(round(balanus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))
# 
# balanus_ziNB <- update(balanus_zipoisson, family = nbinom2)
# 
# balanus_ziNB1 <- update(balanus_zipoisson, family = nbinom1)
# # 
# AICtab(balanus_NB1, balanus_gaussian, balanus_tweedie, balanus_zipoisson, balanus_ziNB, balanus_ziNB1, balanus_beta)

```

Checking model assumptions:  
```{R Survey Balanus: checking model assumptions, echo = TRUE}
#checking assumptions 
set.seed(6789)
balanus_sim_res <- simulateResiduals(balanus_beta)

plot(balanus_sim_res)
# plot residuals against time

par(mfrow = c(1,2))
plotResiduals(balanus_sim_res, form = survey_data$month) # different levels of variance in each month 
#plot residuals against salinity regime
plotResiduals(balanus_sim_res, form = survey_data$salinity_regime) 
```  
Adding a dispersion formula for salinity regime and month 
```{R Survey Balanus: refining model}

#adding a dispersion formula
balanus_beta_2 <- glmmTMB(balanus_beta ~ month + salinity_regime +  (1|salinity_regime/site), dispformula = ~month, data = survey_data, family = beta_family(link = "logit"))

#checking assumptions 
set.seed(1200)
balanus_sim_res_2 <- simulateResiduals(balanus_beta_2)
res <-  recalculateResiduals(balanus_sim_res_2, group = survey_data$month)
plot(balanus_sim_res_2) #all assumptions met 

testTemporalAutocorrelation(res, time = unique(barnacle_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
plotResiduals(balanus_sim_res_2, form = survey_data$month) # good 
plotResiduals(balanus_sim_res_2, form = survey_data$salinity_regime) #good

```
   
**Balanus model output:** 
```{R Survey Balanus: model summary and plot}

# parameters
coef <- summary(balanus_beta_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Balanus survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(balanus_beta_2, type = "II") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Balanus survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

balanus_anova_table <- car::Anova(balanus_beta_2, type = "II") %>% 
  tidy()

grp_means_log <- emmeans(balanus_beta_2, specs = pairwise ~ month, data = barnacle_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Balanus survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:6, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Survey Balanus: final plot, fig.cap = "Balanus abundance (% cover) in from transects in high and low salinity sites over the summer"}

# CLDs_to_plot(balanus_NB1_2)
grp_means_log.df <- summary(grp_means_log$contrasts)

grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 

letters_to_plot <- letters %>% 
  dplyr::rename(month = Group)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(balanus_pt + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = "month")

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_balanus_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(balanus_pt + 1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover))", x = "month", title = "balanus") + 
  scale_fill_manual(values = cols) + 
  theme(legend.position = "none") +  
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(balanus_pt + 1), fill = salinity_regime)) +
  labs(y = "balanus abundance (log(% cover))", x = "month") + 
    scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.25, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "left",
    legend.margin = margin(6, 6, 6, 6)
    ) +
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_balanus.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

#### Chthamalus models
Only 1 plot at Rope Site has Chthamalus in it, and no plots at Lions Bay. This is causing convergence issues 
```{R Survey Chthamalus: models, echo = TRUE}

n <- 8
s <- 0.5

survey_data <- survey_data %>% 
  mutate(chthamalus_beta = ((chthamalus_pt/100)*(n-1) + s)/n)


chthamalus_beta <- glmmTMB(chthamalus_beta ~ month + salinity_regime + (1|salinity_regime/site), data = survey_data, family = beta_family(link = "logit")) # Doesn't fit the data well 

chthamalus_zibeta <- glmmTMB(chthamalus_beta ~ month + salinity_regime + (1|salinity_regime/site), ziformula = ~1, data = survey_data, family = beta_family(link = "logit")) # won't converge

chthamalus_poisson <- glmmTMB(round(chthamalus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log")) #convergence problems

chthamalus_NB <- update(chthamalus_poisson, family = nbinom2)

chthamalus_NB1 <- update(chthamalus_poisson, family = nbinom1)

chthamalus_gaussian <- glmmTMB((chthamalus_pt+1) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

chthamalus_tweedie <- glmmTMB(chthamalus_pt ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
chthamalus_zipoisson <- glmmTMB(round(chthamalus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

chthamalus_ziNB <- glmmTMB(round(chthamalus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = nbinom2(link = "log"))

chthamalus_ziNB1 <- update(chthamalus_ziNB, family = nbinom1) # best model

AICtab(chthamalus_NB, chthamalus_NB1, chthamalus_poisson,  chthamalus_tweedie, chthamalus_gaussian, chthamalus_zipoisson, chthamalus_ziNB, chthamalus_ziNB1)

```

Checking model assumptions:  
```{R Survey Chthamalus: checking model assumptions}
chthamalus_sim_res <- simulateResiduals(chthamalus_ziNB1)

plot(chthamalus_sim_res)
plotResiduals(chthamalus_sim_res, form = survey_data$salinity_regime) # more variance in low salinity region
```   
  
Adding a dispersion formula for salinity regime.  
```{R Survey Chthamalus: refining the model}
chthamalus_ziNB1_2 <- glmmTMB(round(chthamalus_pt) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, dispformula = ~salinity_regime, family = nbinom2(link = "log"))

chthamalus_sim_res_2 <- simulateResiduals(chthamalus_ziNB1_2)

par(mfrow = c(1,2))
plotResiduals(chthamalus_sim_res_2, form = survey_data$salinity_regime)
plotResiduals(chthamalus_sim_res_2, form = survey_data$month)

```

**Chthamalus model output:**
```{R Survey Chthamalus: model output and plots}

# parameters
coef <- summary(chthamalus_ziNB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to chthamalus survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(chthamalus_ziNB1_2, type = "II") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to chthamalus survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

chthamalus_anova_table <- car::Anova(chthamalus_ziNB1_2, type = "II") %>% 
  tidy()

grp_means_log <- emmeans(chthamalus_ziNB1_2, specs = pairwise ~ salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to chthamalus survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Survey Chthamalus: final plot, fig.cap = "Chthamalus abundance from transect data in low and high salinity sites over the summer"}

grp_means_log.df <- summary(grp_means_log$contrasts)

grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 

letters_to_plot <- letters %>% 
  rename(salinity_regime = Group)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(chthamalus_pt + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = "salinity_regime")

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_chthamalus_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(chthamalus_pt+1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "chthamalus") + 
    scale_fill_manual(values = cols) + 
  theme(legend.position = "none") +  
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(chthamalus_pt+1), fill = salinity_regime)) +
  labs(y = "Chthamalus abundance (log(% cover + 1))", x = "month") + 
    scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_chthamalus.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

### Invertebrate Plots 
```{R Invertebrates plots and anova table}
survey_inverts_plots <- plot_grid(survey_limpets_plot, survey_littorines_plot, survey_balanus_plot, survey_chthamalus_plot)

ggsave(here::here("figures", "survey_inverts_plot.png"), plot = survey_inverts_plots, device = png, width = 12, height = 8)

invert_anova_table <- rbind(limpet_anova_table, littorines_anova_table, balanus_anova_table, chthamalus_anova_table)

invert_anova_table <- invert_anova_table %>%
  dplyr::rename(source = term) %>%
  filter(source != "(Intercept)")

write_csv(invert_anova_table, here::here("results", "survey_invert_anova_table.csv"))
```
### Algae 

#### Taxonomic Groups
```{R Survey  Algae: data prep}

survey_data <- survey_data %>% 
  mutate(algae = fucus_pt + ulva_pt + hildenbrandia_pt + mastocarpus_pt + mastocarpus_crust_pt + pyropia_pt + endocladia_pt + microcladia_pt + polysiphonia_pt + diatoms_pt + urospora_pt + acrosiphonia_pt + melanosiphon_pt + leathesia_pt) %>% 
  mutate(browns = fucus_pt + melanosiphon_pt + leathesia_pt,
         greens = ulva_pt + urospora_pt + acrosiphonia_pt,
         reds = pyropia_pt + hildenbrandia_pt + mastocarpus_pt + mastocarpus_crust_pt + endocladia_pt + microcladia_pt + polysiphonia_pt) %>%
  mutate(grazed = ulva_pt + pyropia_pt + polysiphonia_pt + diatoms_pt + urospora_pt + acrosiphonia_pt,
  non_grazed = fucus_pt, mastocarpus_pt, mastocarpus_crust_pt, hildenbrandia_pt, endocladia_pt, melanosiphon_pt, leathesia_pt)
  
survey_data %>% 
  pivot_longer(cols = c("browns", "greens", "reds", "diatoms_pt"), names_to = "taxonomic_groups", values_to = "percent_cover") %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = taxonomic_groups, y = log(percent_cover + 1)))
```  

##### Reds  
Species:  
*Pyropia*, *Hildenbrandia*, *Mastocarpus*, *Mastocarpus* crust, *Endocladia*, *Microcladia*, and *Polysiphonia*  
**Notes**   
Mostly Mastocarpus and Pyropia  
Not very much red in the Sept/low plots.  
Looks like there isn't a lot at Rope Site.    
```{R Survey Red algae: plots}
survey_data %>% 
  pivot_longer(cols = c("pyropia_pt", "hildenbrandia_pt", "mastocarpus_pt", "mastocarpus_crust_pt", "endocladia_pt", "microcladia_pt", "polysiphonia_pt"), names_to = "species", values_to = "percent_cover") %>% mutate(species = str_replace(species, "_pt", "")) %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = species, y = log(percent_cover + 1))) + 
  theme(axis.text = element_text(size = 8))

a <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(round(reds)+1), color = salinity_regime)) + 
  theme(axis.text = element_text(size = 8))

b <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = site, y = log(round(reds)+1), color = salinity_regime)) + 
  theme(axis.text = element_text(size = 8))

par(mfrow = c(1,2))
a + b

```

```{R Survey Red algae: models, echo = TRUE}
survey_data <- survey_data %>% 
  mutate(reds_beta = ((reds/100)*(n-1) + s)/n)

reds_beta <- glmmTMB(reds_beta ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = beta_family(link = "logit")) 

red_poisson <- glmmTMB(round(reds) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

red_NB <- update(red_poisson, family = nbinom2) 

red_NB1 <- update(red_poisson, family = nbinom1) #best model 

red_gaussian <- glmmTMB((reds+1) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

red_tweedie <- glmmTMB(reds ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
red_zipoisson <- glmmTMB(round(reds) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

red_ziNB <- update(red_zipoisson, family = nbinom2)

red_ziNB1 <- update(red_zipoisson, family = nbinom1) # convergence issues 

```

There is basically no red algae at Rope Site, which is making it very difficult to fit a model that meets the assumption of homogeneity of variance. 
```{R Survey Red algae: model selection and checking model assumptions}
AICtab(red_poisson, red_NB, red_NB1, red_gaussian, red_tweedie, red_zipoisson, red_ziNB)

#checking assumptions 
set.seed(4000)
red_sim_res <- simulateResiduals(red_NB1)
res <-  recalculateResiduals(red_sim_res, group = survey_data$month)

plot(red_sim_res)
testTemporalAutocorrelation(res, time = unique(survey_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
# plot residuals against time
plotResiduals(red_sim_res, form = survey_data$month) # good
#plot residuals against salinity regime
plotResiduals(red_sim_res, form = survey_data$salinity_regime) #more variance in low salinity 

```  

Adding a dispersion parameter for salinity_regime: 
```{R Survey Red algae: refining model}

red_NB1_2 <- glmmTMB(round(reds) ~ month + salinity_regime +  (1|salinity_regime/site), dispformula = ~salinity_regime, data = survey_data, family = nbinom1(link = "log")) 

set.seed(5000)
red_sim_res_2 <- simulateResiduals(red_NB1_2)

plot(red_sim_res_2) # looks good

par(mfrow = c(1,2))
plotResiduals(red_sim_res_2, form = survey_data$month) # good
plotResiduals(red_sim_res_2, form = survey_data$salinity_regime) # still has heterogeneity 

```  

Adding dispersion parameter for site instead: 
This increases the p valye for month from 0.06 to 0.09
```{R Survey Red algae: refining model part 2}

# red_NB1_3 <- glmmTMB(round(reds) ~ month + salinity_regime +  (1|salinity_regime/site), dispformula = ~ site, data = survey_data, family = nbinom1(link = "log")) 
# 
# set.seed(6000)
# red_sim_res_3 <- simulateResiduals(red_NB1_3)
# 
# plot(red_sim_res_3) # looks good
# 
# par(mfrow = c(1,2))
# plotResiduals(red_sim_res_3, form = survey_data$month) # good
# plotResiduals(red_sim_res_3, form = survey_data$salinity_regime) # good

```  

**Red Algae model output:**
```{R Survey Red algae: model summary and plot}

# parameters
coef <- summary(red_NB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to red algae survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(red_NB1_2, type = "II") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to red algae survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

red_anova_table <- car::Anova(red_NB1_3, type = "II") %>% 
  tidy()

grp_means_log <- emmeans(red_NB1_3, specs = pairwise ~ salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to red algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:6, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Survey Red algae: final plot, fig.cap = "Red Algae (percent cover) from transect data in low and high salinity sites over the summer"}

# CLDs_to_plot(red_NB1_3)
grp_means_log.df <- summary(grp_means_log$contrasts)

grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 

letters_to_plot <- letters %>% 
  rename(salinity_regime = Group)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(reds + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = "salinity_regime")

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_reds_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(reds+1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "red algae") + 
  scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    ) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(reds+1), fill = salinity_regime)) +
  labs(y = "Red algae abundance (log(% cover + 1))", x = "month") + 
  scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 
  
ggsave(here::here("figures", "survey_redalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

##### Greens
Species:
ulva_pt, urospora_pt, acrosiphonia_pt  

**Notes**   
Mostly **Ulva**
```{R Survey Green algae: plots}
survey_data %>% 
  pivot_longer(cols = c("ulva_pt", "urospora_pt", "acrosiphonia_pt"), names_to = "species", values_to = "percent_cover") %>% 
  ggplot(data = .) + geom_boxplot(aes(x = species, y = log(percent_cover + 1)))

```

```{R Survey Green algae: models, echo = TRUE}
survey_data <- survey_data %>% 
  mutate(greens_beta = ((greens/100)*(n-1) + s)/n)

green_beta <- glmmTMB(greens_beta ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = beta_family(link = "logit"))

green_poisson <- glmmTMB(round(greens) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

green_NB <- update(green_poisson, family = nbinom2) 

green_NB1 <- update(green_poisson, family = nbinom1) #best model 

green_gaussian <- glmmTMB((greens+1) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

green_tweedie <- glmmTMB(greens ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
green_zipoisson <- glmmTMB(round(greens) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

green_ziNB <- update(green_zipoisson, family = nbinom2) #convergence issues

green_ziNB1 <- update(green_zipoisson, family = nbinom1) #convergence issues

```

Checking model assumptions:  
```{R Survey Green algae: model selection and checking model assumptions}

AICtab(green_poisson, green_NB, green_NB1, green_gaussian, green_tweedie, green_zipoisson)

#checking assumptions 
set.seed(7000)
green_sim_res <- simulateResiduals(green_NB1)
res <-  recalculateResiduals(green_sim_res, group = survey_data$month)

plot(green_sim_res) # all assumptions met
testTemporalAutocorrelation(res, time = unique(survey_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
# plot residuals against time
plotResiduals(green_sim_res, form = survey_data$month) 
#plot residuals against salinity regime
plotResiduals(green_sim_res, form = survey_data$salinity_regime) 

```

**Green Algae model summary:**
```{R Survey Green algae: model summary and plot}

# parameters
coef <- summary(green_NB1)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to green algae survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(green_NB1, type = "II") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to green algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

green_anova_table <- car::Anova(green_NB1, type = "II") %>% 
  tidy()

# grp_means_log <- emmeans(green_NB1, specs = pairwise ~ month | salinity_regime, data = survey_data)

# since only month is significant, taking out the salinity_regime part 
grp_means_log <- emmeans(green_NB1, specs = pairwise ~ month, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to green algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:6, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```


```{R Survey Green algae: final plot, fig.cap = "Green Algae from transects in low and high salinity sites over the summer"}

# CLDs_to_plot(green_NB1)

grp_means_log.df <- summary(grp_means_log$contrasts)

grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 

letters_to_plot <- letters %>% 
  rename(month = Group)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(greens + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = "month")

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_greens_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(greens+1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "green algae") + 
  scale_fill_manual(values = cols) + 
  theme(legend.position = "none") + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(greens+1), fill = salinity_regime)) +
  labs(y = "Green algae abundance (log(% cover + 1))", x = "month") + 
  scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_greenalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

##### Browns
Species: *fucus*, *melanosiphon*, *leathesia*  
**Notes**  
Mostly fucus  
```{R Survey Brown algae: plots}
survey_data %>% 
  pivot_longer(cols = c("fucus_pt", "melanosiphon_pt", "leathesia_pt"), names_to = "species", values_to = "percent_cover") %>% 
  ggplot(data = .) + geom_boxplot(aes(x = species, y = percent_cover))

```

```{R Survey Brown algae: models, echo = TRUE}
brown_data <- survey_data %>% 
  mutate(browns = browns/100)

brown_data$browns[which(brown_data$browns == 0)] <- 0.01
brown_data$browns[which(brown_data$browns == 1)] <- 0.99
  
brown_beta <- glmmTMB(browns ~ month + salinity_regime +  (1|salinity_regime/site), data = brown_data, family = beta_family(link = "logit"))


brown_poisson <- glmmTMB(round(browns) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

brown_NB <- update(brown_poisson, family = nbinom2) 

brown_NB1 <- update(brown_poisson, family = nbinom1) #best model 

brown_gaussian <- glmmTMB((browns+1) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

brown_tweedie <- glmmTMB(browns ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
brown_zipoisson <- glmmTMB(round(browns) ~ month + salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

brown_ziNB <- update(brown_zipoisson, family = nbinom2) 

brown_ziNB1 <- update(brown_zipoisson, family = nbinom1) 

```

Checking assumptions: 
```{R Survey Brown algae: model selection and checking model assumptions}

AICtab(brown_poisson, brown_NB, brown_NB1, brown_gaussian, brown_tweedie, brown_zipoisson, brown_ziNB, brown_ziNB1)

set.seed(8000)
brown_sim_res <- simulateResiduals(brown_NB1)
res <-  recalculateResiduals(green_sim_res, group = survey_data$month)

plot(brown_sim_res) 

testTemporalAutocorrelation(res, time = unique(survey_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
# plot residuals against time
plotResiduals(brown_sim_res, form = survey_data$month) 
#plot residuals against salinity regime
plotResiduals(brown_sim_res, form = survey_data$salinity_regime) # more variance in low salinity plots  

```  


Adding a dispersion parameter for salinity_regime: 
```{R Survey Brown algae: refining model}
#adding a dispersion formula for heterogeneity 
brown_NB1_2 <- glmmTMB(round(browns) ~ month + salinity_regime +  (1|salinity_regime/site), dispformula = ~salinity_regime, data = survey_data, family = nbinom1(link = "log")) # final model 

set.seed(9000)
brown_sim_res_2 <- simulateResiduals(brown_NB1_2)

par(mfrow = c(1,2))
plotResiduals(brown_sim_res_2, form = survey_data$salinity_regime) # still more variance in low salinity plots  
plotResiduals(brown_sim_res_2, form = survey_data$site) 
```  

Adding dispersion parameter for site instead: 
By adding this dispersion formula it increases the p value for salinity regime from 0.1 to 0.25.
```{R Survey Brown algae: refining model part 2}

# Let's add a dispersion formula for site instead
brown_NB1_3 <- glmmTMB(round(browns) ~ month + salinity_regime +  (1|salinity_regime/site), dispformula = ~site, data = survey_data, family = nbinom1(link = "log")) # final model 


set.seed(10000)
brown_sim_res_3 <- simulateResiduals(brown_NB1_3)

par(mfrow = c(1,2))
plotResiduals(brown_sim_res_3, form = survey_data$site) # looks better
plotResiduals(brown_sim_res_3, form = survey_data$salinity_regime) # looks better

```

**Brown algae model summary:**
```{R Survey Brown algae: model summary and plot}

# parameters
coef <- summary(brown_NB1_3)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to littorine survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(brown_NB1_3, type = "II") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to brown algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

brown_anova_table <- car::Anova(brown_NB1_3, type = "II") %>% 
  tidy()

# grp_means_log <- emmeans(brown_NB1_3, specs = pairwise ~ month | salinity_regime, data = survey_data)

# since only month is significant, taking out the salinity_regime part 
grp_means_log <- emmeans(brown_NB1_3, specs = pairwise ~ month, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to brown algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:6, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Survey Brown algae: final plot}
  
grp_means_log.df <- summary(grp_means_log$contrasts)
  
grp_means_log.df <- grp_means_log.df %>% 
    dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 

letters_to_plot <- letters %>% 
  rename(month = Group)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(browns + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = "month")

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_browns_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(browns + 1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "brown algae") + 
  scale_fill_manual(values = cols) + 
   theme(legend.position = "none") + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(browns + 1), fill = salinity_regime)) +
  labs(y = "Brown algae abundance (log(% cover + 1))", x = "month") + 
  scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_brownalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

##### Taxonomic Algae Plot
```{R Survey algae by taxonomy plot and anova table}
plot_grid(survey_browns_plot, survey_greens_plot, survey_reds_plot, nrow = 1, ncol = 3)

ggsave(here::here("figures", "survey_taxonomic_algae.png"), plot = last_plot(), device = png, width = 12, height = 8)

algae_taxonomy_anova_table <- rbind(brown_anova_table, green_anova_table, red_anova_table)

algae_taxonomy_anova_table <- algae_taxonomy_anova_table %>% 
  dplyr::rename(source = term) %>% 
  filter(source != "(Intercept)")

write_csv(algae_taxonomy_anova_table, here::here("results", "survey_taxonomic_algae_anova_table.csv"))
```
#### Functional Algal Groupings
Grazed (sheets and filaments) vs. Non grazed (leathery, calcareous, crustose). Is there a better term for this?

**Grazed**
Filaments, sheets
*Ulva*, *Pyropia*, *Polysiphonia*, Diatoms, *Urospora*, *Acrosiphonia*

**Non-grazed**
Turfs, crusts
*Fucus*, *Mastocarpus*, *Mastocarpus* crust, *Hildenbrandia*, *Endocladia*, *Melanosiphon* (not sure if this is the right grouping), *leathesia*
Endocladia and Mastocarpus both part of Lottia diet though?


```{R Survey Algae Functional Group: plots, out.width = "100%"}

a <- survey_data %>% 
  pivot_longer(cols = c("ulva_pt", "pyropia_pt", "polysiphonia_pt", "diatoms_pt", "urospora_pt", "acrosiphonia_pt"), names_to = "species", values_to = "percent_cover") %>% 
  mutate(species = str_replace(species, "_pt", "")) %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = species, y = log(percent_cover+1))) + 
  labs(title = "grazed algae species") + 
  theme(axis.text = element_text(size = 6))

b <- survey_data %>% 
  pivot_longer(cols = c("fucus_pt", "mastocarpus_pt", "mastocarpus_crust_pt", "hildenbrandia_pt", "endocladia_pt", "melanosiphon_pt", "leathesia_pt"), names_to = "species", values_to = "percent_cover") %>% 
  mutate(species = str_replace(species, "_pt", "")) %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = species, y = log(percent_cover+1))) + 
  labs(title = "non-grazed algae species")+ 
  theme(axis.text = element_text(size = 6))

par(mfrow = c(1,2))
a + b

```

##### Grazed Algae
```{R Survey Grazed algae: models, echo = TRUE}
grazed_algae_poisson <- glmmTMB(round(grazed) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

grazed_algae_NB <- update(grazed_algae_poisson, family = nbinom2) # Best model 

grazed_algae_NB1 <- update(grazed_algae_poisson, family = nbinom1) 

grazed_algae_gaussian <- glmmTMB((grazed+1) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

grazed_algae_tweedie <- glmmTMB(grazed ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
grazed_algae_zipoisson <- glmmTMB(round(grazed) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

grazed_algae_ziNB <- update(grazed_algae_zipoisson, family = nbinom2)

grazed_algae_ziNB1 <- update(grazed_algae_zipoisson, family = nbinom1) 

```

Grazed algae: checking model assumptions  
```{R Survey Grazed algae: model selection and checking model assumptions}

AICtab(grazed_algae_poisson, grazed_algae_NB, grazed_algae_NB1, grazed_algae_gaussian, grazed_algae_tweedie, grazed_algae_zipoisson, grazed_algae_ziNB, grazed_algae_ziNB1)


#checking assumptions 
set.seed(5000)
grazed_algae_sim_res <- simulateResiduals(grazed_algae_NB)
res <-  recalculateResiduals(grazed_algae_sim_res, group = survey_data$month)

plot(grazed_algae_sim_res) # assumptions look good 
testTemporalAutocorrelation(res, time = unique(survey_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
plotResiduals(grazed_algae_sim_res, form = survey_data$month)
plotResiduals(grazed_algae_sim_res, form = survey_data$salinity_regime)

```  

**Grazed algae model summary**
```{R Survey Grazed algae: model summary and plot}

# parameters
coef <- summary(grazed_algae_NB)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to grazed algae survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(grazed_algae_NB) %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to grazed algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

grazed_anova_table <- car::Anova(grazed_algae_NB, type = "III") %>% 
  tidy()

grp_means_log <- emmeans(grazed_algae_NB, specs = pairwise ~ month | salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to grazed algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Survey Grazed algae: final plot}

CLDs_to_plot(grazed_algae_NB)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(grazed + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = c("salinity_regime", "month"))

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_grazed_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(grazed+1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "grazed algae") + 
  scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(grazed+1), fill = salinity_regime)) +
  labs(y = "grazed algae abundance (log(% cover + 1))", x = "month") + 
  scale_fill_manual(values = cols) + 
  geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_grazedalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

##### Non grazed algae  
```{R Survey Non-grazed algae: models, echo = TRUE}
non_grazed_algae_poisson <- glmmTMB(round(non_grazed) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = poisson(link = "log"))

non_grazed_algae_NB <- update(non_grazed_algae_poisson, family = nbinom2) # Best model 

non_grazed_algae_NB1 <- update(non_grazed_algae_poisson, family = nbinom1) 

non_grazed_algae_gaussian <- glmmTMB((non_grazed+1) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = gaussian(link = "log"))

non_grazed_algae_tweedie <- glmmTMB(non_grazed ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, family = tweedie(link = "log"))

# models with zero-inflation
non_grazed_algae_zipoisson <- glmmTMB(round(non_grazed) ~ month * salinity_regime +  (1|salinity_regime/site), data = survey_data, ziformula = ~1, family = poisson(link = "log"))

non_grazed_algae_ziNB <- update(non_grazed_algae_zipoisson, family = nbinom2)
# convergence issues 

non_grazed_algae_ziNB1 <- update(non_grazed_algae_zipoisson, family = nbinom1)

AICtab(non_grazed_algae_poisson, non_grazed_algae_NB, non_grazed_algae_NB1, non_grazed_algae_gaussian, non_grazed_algae_tweedie, non_grazed_algae_zipoisson, non_grazed_algae_ziNB1)

```  

Checking model assumptions: 
```{R Survey Non-grazed algae: checking model assumptions}
#checking assumptions 
set.seed(1212)
non_grazed_algae_sim_res <- simulateResiduals(non_grazed_algae_NB1)

plot(non_grazed_algae_sim_res) # unequal within group variance 
# plot residuals against time

par(mfrow = c(1,2))
plotResiduals(non_grazed_algae_sim_res, form = survey_data$month) # equal variance across months
#plot residuals against salinity regime
plotResiduals(non_grazed_algae_sim_res, form = survey_data$salinity_regime) # more variance in the high salinity sites

```   

Adding a dispersion parameter for salinity regime: 
```{R Survey Non-grazed algae: refining model }
#adding a dispersion formula
non_grazed_algae_NB1_2 <- glmmTMB(round(non_grazed) ~ month * salinity_regime +  (1|salinity_regime/site), dispformula = ~salinity_regime, data = survey_data, family = nbinom1(link = "log"))

#checking assumptions 
set.seed(1111)
non_grazed_algae_sim_res_2 <- simulateResiduals(non_grazed_algae_NB1_2)
plotResiduals(non_grazed_algae_sim_res_2, form = survey_data$salinity_regime) # still unequal

```  

Adding a dispersion formula for site instead: 
```{R Survey Non-grazed algae: refining model part 2}

#adding a dispersion formula
non_grazed_algae_NB1_3 <- glmmTMB(round(non_grazed) ~ month * salinity_regime +  (1|salinity_regime/site), dispformula = ~site, data = survey_data, family = nbinom1(link = "log"))

set.seed(9999)
non_grazed_algae_sim_res_3 <- simulateResiduals(non_grazed_algae_NB1_3)

res <-  recalculateResiduals(non_grazed_algae_sim_res_3, group = survey_data$month)

plot(non_grazed_algae_sim_res_3) # good
testTemporalAutocorrelation(res, time = unique(survey_data$month)) # no temporal autocorrelation

par(mfrow = c(1,2))
plotResiduals(non_grazed_algae_sim_res_3, form = survey_data$salinity_regime) # good
plotResiduals(non_grazed_algae_sim_res_3, form = survey_data$month) # good

```  

**Non-Grazed Algae model summary:**  
```{R Survey Non-grazed algae: model summary and plot}

# parameters
coef <- summary(non_grazed_algae_NB1_3)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Non-grazed algae survey data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(non_grazed_algae_NB1_3) %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Non-grazed algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

nongrazed_anova_table <- car::Anova(non_grazed_algae_NB1_3, type = "III") %>% 
  tidy()

grp_means_log <- emmeans(non_grazed_algae_NB1_3, specs = pairwise ~ month | salinity_regime, data = survey_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Non-grazed algae survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Survey Non-grazed Algae: final plot, fig.cap = "Abundance of non-grazed algae from transects in low and high salinity sites over the summer"}

CLDs_to_plot(non_grazed_algae_NB1_3)

survey_quant <- survey_data %>% 
  dplyr::group_by(salinity_regime, month) %>% 
  dplyr::summarise(quant = quantile(log(non_grazed + 1), .75)) %>% 
  dplyr::select(month, salinity_regime, quant)

survey_quant <- left_join(survey_quant, letters_to_plot, by = c("salinity_regime", "month"))

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))

survey_nongrazed_plot <- ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(non_grazed+1), fill = salinity_regime)) +
  labs(y = "abundance (log(% cover + 1))", x = "month", title = "non-grazed algae") + 
  scale_fill_manual(values = cols) + 
   geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggplot(data = survey_data) + 
  geom_boxplot(aes(x = month, y = log(non_grazed+1), fill = salinity_regime)) +
  labs(y = "Non-grazed algae abundance (log(% cover + 1))", x = "month") + 
  scale_fill_manual(values = cols) + 
   geom_text(data = survey_quant, aes(x = month, y = quant, label = Letter, color = salinity_regime), show.legend = FALSE,
            position = position_dodge(0.5), vjust = -1, check_overlap = FALSE) + 
  scale_color_manual(values = col_text) 

ggsave(here::here("figures", "survey_nongrazedalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")

```

### Survey functional algae plot and anova table
```{R Survey functional algae plot}
plot_grid(survey_grazed_plot, survey_nongrazed_plot)

ggsave(here::here("figures", "survey_functional_algae.png"), plot = last_plot(), device = png, width = 12, height = 8)

algae_functional_anova_table <- rbind(grazed_anova_table, nongrazed_anova_table)

algae_functional_anova_table <- algae_functional_anova_table %>% 
  dplyr::rename(source = term) %>% 
  filter(source != "(Intercept)")

write_csv(algae_functional_anova_table, here::here("results", "survey_functional_algae_anova_table.csv"))
```
## Field Experiment Data
**Notes**  
Only using the control and exclusion plots.   
Not modelling limpets b/c they will be different due to treatment.  
Do we just assume the herbivores that were removed from the exclusion plots were not having an impact on the community? i.e. they weren't there for long enough?  
Waiting to hear back from Theraesa about:  
*Additional Limpets in ring (Removed)* two of the control plots show 34 and 1 paradigitalis in this column but 0s under the paradigitalis column.  
*Total Limpets (Non-Pelta removed from rings)*  some of the control plots have other limpet species as removed?
*Littorina Removed from Ring (#)* some of the control plots have littorines removed?  

Species: Balanus, Chthamalus, limpets, littorina, mytilus, amphipods diatoms, pyropia, fucus, ulva, 
```{R Field experimental data prep}
exp_data <- read_csv(here::here("data", "tidy", "field_exclusion_tidy.csv"))

exp_data <- exp_data %>% 
  mutate(treatment = factor(treatment, levels = c("control", "exclusion")),
         region = factor(region, levels = c("Low", "High")),
         site = factor(site, levels = c("Lions Bay 2", "Rope Site 2", "Horseshoe Bay", "Ruckle", "Eagle Cove", "Hailstorm 2"))) %>% 
  select(-c(reds_fucus, greens_pyropia)) %>% 
  mutate(limpets = paradigitalis_no + unknown_limpets_no) %>% 
  mutate(reds = pyropia_pt + masto_crust_pt, 
         greens = ulva_pt, 
         browns = fucus_pt) %>% # Do I put diatoms with browns?? Or a separate category?
  mutate(grazed = ulva_pt + pyropia_pt + diatom_pt,
         nongrazed = fucus_pt + masto_crust_pt) %>% 
  mutate(algae = masto_crust_pt + diatom_pt + ulva_pt + pyropia_pt + fucus_pt)

```

### Limpets and Littorines

Check and see whether the exclusion plots had less limpets than the controls. We expect the interaction to be significant as well. I'm using data from May, June and July for this as previous months will have had an impact on July's communities as well.
```{R Experiment Limpets and Littorines: data prep}
exp_grazers <- read_csv(here::here("data", "raw", "Raw_Count_Data.csv"))

# More littorines in control plot than exclusion in high salinity region 
exp_grazers %>% filter(Treatment != "I") %>% ggplot(data = .) + geom_boxplot(aes(x = Region, y = log(`Total Littorina (#)` + 1), fill = Treatment))

# same amount, but then more limpets were taken out... ?
exp_grazers %>% filter(Treatment != "I") %>% ggplot(data = .) + geom_boxplot(aes(x = Region, y = log(`Total Limpets in Ring Before adding/subtracting` + 1), fill = Treatment))

exp_grazers %>% filter(Treatment != "I") %>% ggplot(data = .) + geom_boxplot(aes(x = Region, y = log(`Total Littorina (#)` + `Total Limpets in Ring Before adding/subtracting` + 1), fill = Treatment))

exp_grazers <- exp_grazers %>% 
  mutate(all_grazers =  `Total Littorina (#)` + `Total Limpets in Ring Before adding/subtracting`) %>% 
  filter(Month != "September") %>% 
  filter(Treatment != "I") %>% 
  select(Month, Region, Site, Replicate, Treatment, all_grazers) %>% 
  mutate(Treatment = factor(Treatment, levels = c("C", "E")),
         Region = factor(Region, levels = c("Low", "High")))

names(exp_grazers) <- tolower(names(exp_grazers))
  
```


```{R Experiment grazers: models}
exp_grazers_poisson <- glmmTMB(all_grazers ~ treatment * region +  (1|region/site), data = exp_grazers, family = poisson(link = "log"))

exp_grazers_NB <- update(exp_grazers_poisson, family = nbinom2) # best model

exp_grazers_NB1 <- update(exp_grazers_poisson, family = nbinom1) 

exp_grazers_gaussian <- glmmTMB((all_grazers+1) ~ treatment * region +  (1|region/site), data = exp_grazers, family = gaussian(link = "log"))

exp_grazers_tweedie <- glmmTMB(all_grazers ~ treatment * region +  (1|region/site), data = exp_grazers, family = tweedie(link = "log"))  

# models with zero-inflation
exp_grazers_zipoisson <- glmmTMB(all_grazers ~ treatment * region +  (1|region/site), data = exp_grazers, ziformula = ~1, family = poisson(link = "log"))

exp_grazers_ziNB <- update(exp_grazers_zipoisson, family = nbinom2) # convergence issues

exp_grazers_ziNB1 <- update(exp_grazers_zipoisson, family = nbinom1) # convergence issues

```

```{R Experiment Limpets: model selection and checking assumptions, cache = TRUE}
AICtab(exp_grazers_poisson, exp_grazers_gaussian, exp_grazers_tweedie, exp_grazers_zipoisson, exp_grazers_NB, exp_grazers_NB1)

#checking assumptions 
set.seed(4301)
exp_grazers_sim_res <- simulateResiduals(exp_grazers_NB)

par(mfrow = c(1,2))
plotResiduals(exp_grazers_sim_res, form = exp_grazers$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_grazers_sim_res, form = exp_grazers$region) # unequal

```
```{r exp grazers - refining model}

exp_grazers_NB_2 <- glmmTMB(all_grazers ~ treatment * region +  (1|region/site), dispformula = ~region, data = exp_grazers, family = nbinom2)

#checking assumptions 
set.seed(4301)
exp_grazers_sim_res <- simulateResiduals(exp_grazers_NB_2)

par(mfrow = c(1,2))
plotResiduals(exp_grazers_sim_res, form = exp_grazers$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_grazers_sim_res, form = exp_grazers$region) # good

```

Limpets model output: 
```{R Experiment Limpets: model output}

# parameters
coef <- summary(exp_grazers_NB_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Grazer field experiment data for May, June and July") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_grazers_NB_2) %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Limpet field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_grazers_anova_table <- car::Anova(exp_grazers_NB_2, type = "III") %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  dplyr::rename(source = term)

grp_means_log <- emmeans(exp_grazers_NB_2, specs = pairwise ~ treatment | region, data = exp_grazers)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Limpet field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>%
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Experiment Limpets: final plot}
cols = c("C" = "orange", "E" = "steelblue")
exp_grazers_plot <- ggplot(data = exp_grazers) + 
  geom_boxplot(aes(x = region, y = log(all_grazers + 1), fill = treatment)) + 
  scale_fill_manual(values = cols) + 
  labs(y = "grazer abundance (log + 1)", x = "salinity region")

ggsave(here::here("figures", "exp_grazers_plot.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")

write_csv(exp_grazers_anova_table, here::here("results", "exp_grazers_anova_table.csv"))
```

### Balanus
**Question** How were barnacles counted? How can we have non-integers?
```{R Experiment Balanus: plots, out.width = "80%"}

hist(exp_data$balanus_no)

a <- ggplot(data = exp_data) + geom_boxplot(aes(x = treatment, y  = log(balanus_no)))

b <- ggplot(data = exp_data) + geom_boxplot(aes(x = region, y  = log(balanus_no)))

par(mfrow = c(1,2))
a + b 
```

```{R Experiment Balanus: models, echo = TRUE, cache = TRUE}
exp_balanus_poisson <- glmmTMB(round(balanus_no) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_balanus_NB <- update(exp_balanus_poisson, family = nbinom2) 

exp_balanus_NB1 <- update(exp_balanus_poisson, family = nbinom1) 

exp_balanus_gaussian <- glmmTMB((balanus_no+1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_balanus_tweedie <- glmmTMB(balanus_no ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) # Best model 

# models with zero-inflation
exp_balanus_zipoisson <- glmmTMB(round(balanus_no) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_balanus_ziNB <- update(exp_balanus_zipoisson, family = nbinom2) # convergence issues

exp_balanus_ziNB1 <- update(exp_balanus_zipoisson, family = nbinom1) # convergence issues

```

Checking model assumptions:  
```{R Experiment Balanus: model selection and checking assumptions, cache = TRUE}
AICtab(exp_balanus_poisson, exp_balanus_NB, exp_balanus_NB1, exp_balanus_gaussian, exp_balanus_tweedie, exp_balanus_zipoisson)

#checking assumptions 
set.seed(1234)
exp_balanus_sim_res <- simulateResiduals(exp_balanus_tweedie)

plot(exp_balanus_sim_res) # unequal within group variance 
# plot residuals against treatment

par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res, form = exp_data$treatment) # more variance in control plots
# plot residuals against salinity region
plotResiduals(exp_balanus_sim_res, form = exp_data$region) # more variance in the low salinity sites

```  

Adding a dispersion formula for trmt*region: 
```{R Experiment Balanus: refining model}

# adding a dispersion formula to tweedie distribution
exp_balanus_tweedie_2 <- glmmTMB(balanus_no ~ treatment * region +  (1|region/site), data = exp_data, dispformula = ~treatment*region, family = tweedie(link = "log")) 

set.seed(2021)
exp_balanus_sim_res_2 <- simulateResiduals(exp_balanus_tweedie_2)

par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res_2, form = exp_data$treatment) # good
plotResiduals(exp_balanus_sim_res_2, form = exp_data$region) # not good

# Trying to add a dispersion parameter for each site*trmt combo
exp_balanus_tweedie_3 <- glmmTMB(balanus_no ~ treatment * region +  (1|region/site), data = exp_data, dispformula = ~treatment*site, family = tweedie(link = "log")) # convergence issues 


# adding a dispersion formula with site
exp_balanus_NB1_3 <- glmmTMB(round(balanus_no) ~ treatment * region +  (1|region/site), data = exp_data, dispformula = ~treatment*site, family = nbinom1(link = "log")) 

```  

Trying to fit dispersion formula to treatment*site but it's causing convergence issues.  

```{R Experiment Balanus: refining model part 2}

# adding a dispersion formula for trmt*region to neg binomial distribution
exp_balanus_NB1_2 <- glmmTMB(round(balanus_no) ~ treatment * region +  (1|region/site), data = exp_data, dispformula = ~treatment*region, family = nbinom1(link = "log")) 

set.seed(333)
exp_balanus_sim_res_2 <- simulateResiduals(exp_balanus_NB1_2)
par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res_2, form = exp_data$treatment) # good
plotResiduals(exp_balanus_sim_res_2, form = exp_data$region) # not good

# adding a dispersion formula for trmt*site to neg binomial distribution
exp_balanus_NB1_3 <- glmmTMB(round(balanus_no) ~ treatment * region +  (1|region/site), data = exp_data, dispformula = ~treatment*site, family = nbinom1(link = "log")) 

set.seed(2000)
exp_balanus_sim_res_3 <- simulateResiduals(exp_balanus_NB1_3)

par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res_3, form = exp_data$treatment) # good
plotResiduals(exp_balanus_sim_res_3, form = exp_data$region) # not good

```

What if I don't include site as a random effect, but as a fixed effect instead?
```{R Experiment Balanus: site as fixed effect}
exp_balanus_unnested <- glmmTMB(balanus_no ~ treatment * site, data = exp_data, family = tweedie(link = "log"))

#checking assumptions 
set.seed(122121)
exp_balanus_sim_res <- simulateResiduals(exp_balanus_unnested)

plot(exp_balanus_sim_res) 
# plot residuals against treatment

par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res, form = exp_data$treatment) # more variance in control plots
# plot residuals against salinity region
plotResiduals(exp_balanus_sim_res, form = exp_data$site) # more variance in the low salinity sites

```

Adding a dispersion parameter for treatment*site
```{R Experiment Balanus: refining model part 3}
# adding a dispersion parameter
exp_balanus_unnested_2 <- glmmTMB(balanus_no ~ treatment * site, data = exp_data, dispformula = ~treatment*site, family = tweedie(link = "log"))

set.seed(05302017)
exp_balanus_sim_res_2 <- simulateResiduals(exp_balanus_unnested_2)

plot(exp_balanus_sim_res_2) 
# plot residuals against treatment

par(mfrow = c(1,2))
plotResiduals(exp_balanus_sim_res_2, form = exp_data$treatment) # more variance in control plots
# plot residuals against salinity region
plotResiduals(exp_balanus_sim_res_2, form = exp_data$site) # more variance in the low salinity sites
```

Balanus model output: 
```{R Experiment Balanus: model output}

# parameters
coef <- summary(exp_balanus_unnested_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Balanus field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_balanus_unnested_2, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Balanus field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_balanus_anova_table <- car::Anova(exp_balanus_unnested_2, type = "III") %>% 
  tidy()

grp_means_log <- emmeans(exp_balanus_unnested_2, specs = pairwise ~ site, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Balanus field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>%
  kableExtra::column_spec(1:6, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Experiment Balanus: final plot, fig.cap = "Balanus (percent cover) in control vs. exclusion plots in low and high salinity sites"}

barnacle_data <- exp_data

levels(barnacle_data$site)[levels(barnacle_data$site)=="Ruckle"] <- "RP"
levels(barnacle_data$site)[levels(barnacle_data$site)=="Eagle Cove"] <- "EC"
levels(barnacle_data$site)[levels(barnacle_data$site)=="Hailstorm 2"] <- "HS"
levels(barnacle_data$site)[levels(barnacle_data$site)=="Horseshoe Bay"] <- "HB"
levels(barnacle_data$site)[levels(barnacle_data$site)=="Lions Bay 2"] <- "LB"
levels(barnacle_data$site)[levels(barnacle_data$site)=="Rope Site 2"] <- "RS"
  
cols <- c("RP" = "steelblue", "EC" = "steelblue", "HS" = "steelblue", "HB" = "orange", "LB" = "orange", "RS" = "orange")

exp_balanus_plot <- ggplot(data = barnacle_data) + 
  geom_boxplot(aes(x = region, y = log(balanus_no +1), fill = site)) +
  labs(y = "abundance (log (+ 1))", x = "region", title = "Balanus") + 
  facet_wrap(~treatment, scale = "fixed") + 
  scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.85, .15),
    legend.direction = "horizontal",
    axis.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
      legend.key = element_blank(), 
       legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       legend.text = element_text(size = 9, colour = "grey30"))

ggplot(data = barnacle_data) + 
  geom_boxplot(aes(x = region, y = log(balanus_no +1), fill = site)) +
  labs(y = "Balanus abundance (log (+ 1))", x = "region") + 
  facet_wrap(~treatment, scale = "fixed") + 
  scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.85, .15),
    legend.direction = "horizontal"
    )

ggsave(here::here("figures", "exp_balanus.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")

```

### Chthamalus
```{R Experiment Chthamalus: plots}
a <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(chthamalus_no + 1))) # less variance in exclusion plots

b <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = log(chthamalus_no + 1))) # less variance in low salinity

par(mfrow = c(1,2))
a + b

hist(exp_data$chthamalus_no) # lots of zeros 

```

```{R Experiment Chthamalus: models, echo = TRUE}
exp_chthamalus_poisson <- glmmTMB(round(chthamalus_no) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_chthamalus_NB <- update(exp_chthamalus_poisson, family = nbinom2) 

exp_chthamalus_NB1 <- update(exp_chthamalus_poisson, family = nbinom1) 

exp_chthamalus_gaussian <- glmmTMB((chthamalus_no+1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_chthamalus_tweedie <- glmmTMB(chthamalus_no ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) 

# models with zero-inflation
exp_chthamalus_zipoisson <- glmmTMB(round(chthamalus_no) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_chthamalus_ziNB <- update(exp_chthamalus_zipoisson, family = nbinom2) 

exp_chthamalus_ziNB1 <- update(exp_chthamalus_zipoisson, family = nbinom1) # best model 
```

Model Selection and checking assumptions: 
```{R Experiment Chthamalus: model selection and checking assumptions}
AICtab(exp_chthamalus_poisson, exp_chthamalus_NB, exp_chthamalus_NB1, exp_chthamalus_gaussian, exp_chthamalus_tweedie, exp_chthamalus_zipoisson, exp_chthamalus_ziNB1, exp_chthamalus_ziNB)

#checking assumptions 
set.seed(4444)
exp_chthamalus_sim_res <- simulateResiduals(exp_chthamalus_ziNB1)

plot(exp_chthamalus_sim_res) # looks good

par(mfrow = c(1, 2))
# plot residuals against treatment
plotResiduals(exp_chthamalus_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_chthamalus_sim_res, form = exp_data$region) # good
```

```{R Experiment Chthamalus: model output}
# parameters
coef <- summary(exp_chthamalus_ziNB1)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Chthamalus field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_chthamalus_ziNB1, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Chthamalus field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_chthamalus_anova_table <- car::Anova(exp_chthamalus_ziNB1, type = "III") %>% 
  tidy()

grp_means_log <- emmeans(exp_chthamalus_ziNB1, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Chthamalus field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Experiment Chthamalus: final plot, fig.cap = "Chthamalus (percent cover) in control vs. exclusion plots in low and high salinity sites"}

cols = c("Low" = "orange", "High" = "steelblue")


grp_means_log.df <- summary(grp_means_log$contrasts)
  
grp_means_log.df <- grp_means_log.df %>% 
  dplyr::select(contrast, p.value)
  
letters <- cldList(p.value ~ contrast,
                     data = grp_means_log.df,
                     threshold  = 0.05) 
  
letters$region <- c("Low", "High")
  
letters <- letters %>% 
  rename(treatment = Group)
  
letters_to_plot <- letters 

exp_quant <- exp_data %>% 
  dplyr::group_by(region, treatment) %>% 
  dplyr::summarise(quant = quantile(log(chthamalus_no + 1), .75)) %>% 
  dplyr::select(treatment, region, quant)

exp_quant <- left_join(exp_quant, letters_to_plot, by = c("region", "treatment"))

survey_quant <- survey_quant %>% 
  mutate(month = factor(month, levels = c("May", "June", "July", "September")),
         salinity_regime = factor(salinity_regime, levels = c("L", "H")))
  
exp_chthamalus_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(chthamalus_no +1), fill = region)) +
  labs(y = "abundance (log (+ 1))", x = "treatment", title = "Chthamalus dalli") + 
  scale_fill_manual(values = cols) +
  ylim(0,8) + 
  theme(
    legend.position = c(.85, .85),
    legend.direction = "horizontal",
    axis.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
      legend.key = element_blank(), 
       legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
       legend.text = element_text(size = 9, colour = "grey30"))

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(chthamalus_no +1), fill = region)) +
  labs(y = "Chthamalus abundance (log (+ 1))", x = "treatment") + 
  scale_fill_manual(values = cols) + 
   theme(
    legend.position = c(.85, .95),
    legend.direction = "horizontal"
    )

ggsave(here::here("figures", "exp_chthamalus.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

### Barnacle plot and anova tables
```{R Experiment Barnacle plot and anova table}
exp_barnacles_plot <- plot_grid(exp_balanus_plot, exp_chthamalus_plot, rel_widths = c(.55, .45))

ggsave(here::here("figures", "exp_barnacles_plot.png"), plot = exp_barnacles_plot, device = png, width = 14, height = 8)

exp_balanus_anova_table <- exp_balanus_anova_table %>% 
  dplyr::rename(source = term) %>% 
  filter(source != "(Intercept)")

write_csv(exp_balanus_anova_table, here::here("results", "exp_balanus_anova_table.csv"))

exp_chthamalus_anova_table <- exp_chthamalus_anova_table %>% 
  dplyr::rename(source = term) %>% 
  filter(source != "(Intercept)")

write_csv(exp_chthamalus_anova_table, here::here("results", "exp_chthamalus_anova_table.csv"))

```

### Algae
```{R Experiment Algae (all): plots, out.width = "100%"}

a <- exp_data %>% 
  pivot_longer(cols = c("reds", "greens", "browns", "diatom_pt"), names_to = "taxonomic_groups", values_to = "percent_cover") %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = site, y = log(percent_cover + 1), colour = taxonomic_groups), outlier.colour = NULL) + 
  scale_color_manual(breaks = c("reds", "greens", "browns", "diatom_pt"), values = c("red", "dark green", "brown", "grey")) + 
  theme(axis.text = element_text(size = 8))

b <- exp_data %>% 
  pivot_longer(cols = c("grazed", "nongrazed"), names_to = "functional_groups", values_to = "percent_cover") %>% ggplot(data = .) + 
  geom_boxplot(aes(x = site, y = log(percent_cover + 1), colour = functional_groups), outlier.colour = NULL) + 
  scale_color_manual(breaks = c("grazed", "nongrazed"), values = c("dark green", "red")) + 
  theme(axis.text = element_text(size = 8))

c <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = log(algae + 1), colour = treatment))

par(mfrow = c(1,2))
a + b

par(mfrow = c(1,1))

c

hist(exp_data$algae)

exp_data %>% 
  filter(algae > 0) %>% 
  group_by(site) %>% 
  tally()
```  

Fit models to all algae pooled together: 
```{R Experiment Algae (all): models, echo = TRUE}
#transforming data for beta regression 
n <- 7
s <- 0.5

algae_data <- exp_data %>% 
  mutate(algae_beta = ((algae/100)*(n-1) + s)/n) %>% 
  mutate(reds_beta = ((reds/100)*(n-1) + s)/n) %>% 
  mutate(greens_beta = ((greens/100)*(n-1) + s)/n) %>% 
  mutate(browns_beta = ((browns/100)*(n-1) + s)/n)

algae_beta <- glmmTMB(algae_beta ~ treatment * region +  (1|region/site), data = algae_data, family = beta_family(link = "logit"))

exp_algae_poisson <- glmmTMB(round(algae) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_algae_NB <- update(exp_algae_poisson, family = nbinom2) 

exp_algae_NB1 <- update(exp_algae_poisson, family = nbinom1) 

exp_algae_gaussian <- glmmTMB((algae + 1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_algae_tweedie <- glmmTMB(algae ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log"))

# models with zero-inflation
exp_algae_zipoisson <- glmmTMB(round(algae) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_algae_ziNB <- update(exp_algae_zipoisson, family = nbinom2) 

exp_algae_ziNB1 <- update(exp_algae_zipoisson, family = nbinom1) #best model

algae_zibeta <- glmmTMB(algae_beta ~ treatment * region +  (1|region/site), data = algae_data, ziformula = ~1, family = beta_family(link = "logit"))

```

Checking model assumptions:  
```{R Experiment Algae (all): model selection and checking assumptions}
AICtab(exp_algae_gaussian, exp_algae_NB, exp_algae_NB1, exp_algae_poisson, exp_algae_tweedie, exp_algae_ziNB, exp_algae_ziNB1, exp_algae_zipoisson)

#checking assumptions 
set.seed(9797)
exp_algae_sim_res <- simulateResiduals(algae_beta)
plot(exp_algae_sim_res) # unequal variances

par(mfrow = c(1,2))
plotResiduals(exp_algae_sim_res, form = algae_data$treatment) # good
plotResiduals(exp_algae_sim_res, form = algae_data$region) # good

```


Adding a dispersion parameter for region:  
```{R Experiment Algae (all): refining model}

# adding dispersion formula for treatment
exp_algae_beta_2 <- glmmTMB(algae_beta ~ treatment * region +  (1|region/site), data = algae_data, dispformula = ~treatment, family = beta_family(link = "logit"))
# 
set.seed(8787)
exp_algae_sim_res_2 <- simulateResiduals(exp_algae_beta_2)
plot(exp_algae_sim_res_2) # good!
# 
# par(mfrow = c(1,2))
# plotResiduals(exp_algae_sim_res_2, form = exp_data$treatment) # good
# plotResiduals(exp_algae_sim_res_2, form = exp_data$region) # good
```

model output:
```{R Experiment Algae (all): model output}

# parameters
coef <- summary(algae_beta)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(algae_beta) %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_algae_anova_table <- car::Anova(algae_beta, type = "III") %>% 
  tidy() 

grp_means_log <- emmeans(algae_beta, specs = pairwise ~ treatment | region, data = algae_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Experiment Algae (all): final plot, fig.cap = "Algae in control vs. exclusion plots in low and high salinity sites"}
exp_allalgae_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(algae +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "all algae") + 
  scale_fill_manual(values = cols)

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(algae +1), fill = region)) +
  labs(y = "algae abundance (log (% cover + 1))", x = "treatment") + 
  scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_allalgae.png"), plot = last_plot(), device = png, width = 12, height = 8)

exp_algae_anova_table <- exp_algae_anova_table %>% 
  dplyr::rename(source = term) %>% 
  filter(source != "(Intercept)")

write_csv(exp_algae_anova_table, here::here("results", "exp_algae_anova_table.csv"))
```


#### Taxonomic groupings
##### Red Algae 
Almost all *Mastocarpus* crust with a very small amount of *Pyropia*
```{R Experiment Red algae: plots}
ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = reds))

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = reds))

hist(exp_data$reds)

```

```{R Experiment Red algae: models, echo = TRUE}
exp_red_poisson <- glmmTMB(round(reds) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_red_NB <- update(exp_red_poisson, family = nbinom2) 

exp_red_NB1 <- update(exp_red_poisson, family = nbinom1) 

exp_red_gaussian <- glmmTMB((reds + 1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_red_tweedie <- glmmTMB(reds ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) # best model 

# models with zero-inflation
exp_red_zipoisson <- glmmTMB(round(reds) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_red_ziNB <- update(exp_red_zipoisson, family = nbinom2) 

exp_red_ziNB1 <- update(exp_red_zipoisson, family = nbinom1) 

```

```{R Experiment Red algae: model selection and checking assumptions}
AICtab(exp_red_poisson, exp_red_NB, exp_red_NB1, exp_red_gaussian, exp_red_tweedie, exp_red_ziNB, exp_red_ziNB1, exp_red_zipoisson)

#checking assumptions 
exp_red_sim_res <- simulateResiduals(exp_red_tweedie)
plot(exp_red_sim_res) # good

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_red_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_red_sim_res, form = exp_data$region) # good

```

```{R Experiment Red algae: model outputs}

# parameters
coef <- summary(exp_red_tweedie)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Red Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_red_tweedie) %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Red Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_red_anova_table <- car::Anova(exp_red_tweedie, type = "III") %>% 
  tidy() 

grp_means_log <- emmeans(exp_red_tweedie, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Red Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Experiment Red Algae: final plot, fig.cap = "Red Algae in control vs. limpet exclusion plots in high and low salinity sites"}
exp_reds_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(reds +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "Red algae" ) + 
  scale_fill_manual(values = cols) + 
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(reds +1), fill = region)) +
  labs(y = "Red algae abundance (log (% cover + 1))", x = "treatment") + 
  scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_redalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

##### Green Algae
Only green algae species is *Ulva*  
Only region is significant, because the confidence intervals are very large.  
How many plots, and in which sites, have green algae?
```{R Experiment Green algae: plots}
exp_data %>% filter(greens > 0) %>% group_by(site) %>% tally()

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = log(greens + 1), color = treatment))

hist(exp_data$greens)
```

```{R Experiment Green algae: models, echo = TRUE}
green_data <- exp_data %>% 
  mutate(greens = greens/100)

green_data$greens[which(green_data$greens == 0)] <- 0.01
green_data$greens[which(green_data$greens == 1)] <- 0.99

exp_green_beta <- glmmTMB(greens ~ treatment * region +  (1|region/site), data = green_data, family = beta_family(link = "logit"))

exp_green_poisson <- glmmTMB(round(greens) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_green_NB <- update(exp_green_poisson, family = nbinom2) 

exp_green_NB1 <- update(exp_green_poisson, family = nbinom1) 

exp_green_gaussian <- glmmTMB((greens+1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_green_tweedie <- glmmTMB(greens ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) 

# models with zero-inflation
exp_green_zipoisson <- glmmTMB(round(greens) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_green_ziNB <- update(exp_green_zipoisson, family = nbinom2) 

exp_green_ziNB1 <- update(exp_green_zipoisson, family = nbinom1) # best model 

```

```{R Experiment Green algae: model selection and checking assumptions}
AICtab(exp_green_gaussian, exp_green_NB, exp_green_NB1, exp_green_poisson, 
       exp_green_tweedie, exp_green_ziNB, exp_green_ziNB1, exp_green_zipoisson)

#checking assumptions
set.seed(555)
exp_green_sim_res <- simulateResiduals(exp_green_ziNB1)
plot(exp_green_sim_res) # unequal variance

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_green_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_green_sim_res, form = exp_data$region) # unequal variance
```

Adding a dispersion formula for region: 
```{R Experiment Green algae: refining model}
#adding a dispersion formula for region
exp_green_ziNB1_2 <- glmmTMB(round(greens) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, dispformula = ~region, family = nbinom1(link = "log"))

#checking assumptions 
set.seed(222)
exp_green_sim_res_2 <- simulateResiduals(exp_green_ziNB1_2)
plot(exp_green_sim_res_2) # good

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_green_sim_res_2, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_green_sim_res_2, form = exp_data$region) # good
```


**Green Algae Model outputs:** 
```{R Experiment Green algae: model outputs}

# parameters
coef <- summary(exp_green_ziNB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Green Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_green_ziNB1_2, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Green Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_green_anova_table <- car::Anova(exp_green_ziNB1_2, type = "III") %>% 
  tidy() %>% 
  filter(term != "(Intercept)")

exp_green_anova_table 
  
write_csv(exp_green_anova_table, here::here("results", "exp_green_algae_anova_table.csv"))

grp_means_log <- emmeans(exp_green_ziNB1_2, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Green Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Experiment Green algae: final plot}
exp_greens_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(greens +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "Green algae") + 
    scale_fill_manual(values = cols) +
  theme(legend.position = "none")

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(greens +1), fill = region)) +
  labs(y = "Green algae abundance (log (% cover + 1))", x = "treatment") + 
    scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_greenalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")

```

##### Brown Algae  
Only brown algae species is *Fucus*  
How many plots, and in which sites, have brown algae?  
No brown algae at Ruckle Park 
```{R Experiment Brown algae: initial plots}
exp_data %>% 
  filter(browns > 0) %>% 
  group_by(site) %>% 
  tally()

hist(exp_data$browns)

a <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(browns + 1)))

b <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = log(browns + 1)))

par(mfrow = c(1,2))
a + b

```

```{R Experiment Brown algae: models, echo = TRUE}
exp_brown_poisson <- glmmTMB(round(browns) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_brown_NB <- update(exp_brown_poisson, family = nbinom2) 

exp_brown_NB1 <- update(exp_brown_poisson, family = nbinom1) 

exp_brown_gaussian <- glmmTMB((browns + 1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_brown_tweedie <- glmmTMB(browns ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) # best model 

# models with zero-inflation
exp_brown_zipoisson <- glmmTMB(round(browns) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_brown_ziNB <- update(exp_brown_zipoisson, family = nbinom2) #convergence issues

exp_brown_ziNB1 <- update(exp_brown_zipoisson, family = nbinom1) 

```


Checking assumptions:  
```{R Experiment Brown algae: model selection and checking assumptions}
AICtab(exp_brown_poisson, exp_brown_NB, exp_brown_NB1, exp_brown_gaussian, exp_brown_tweedie, exp_brown_ziNB1, exp_brown_zipoisson)

#checking assumptions 
exp_brown_sim_res <- simulateResiduals(exp_brown_tweedie)
plot(exp_brown_sim_res) # good

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_brown_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_brown_sim_res, form = exp_data$region) # good

```

**Brown Algae Model outputs:**    
```{R Experiment Brown algae: model outputs}

# parameters
coef <- summary(exp_brown_tweedie)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Brown Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_brown_tweedie, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Brown Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_brown_anova_table <- car::Anova(exp_brown_tweedie, type = "III") %>% 
  tidy() 

grp_means_log <- emmeans(exp_brown_tweedie, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Brown Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```

```{R Experiment Brown Algae: final plot, fig.cap = "Brown Algae in control vs. limpet exclusion plots in high and low salinity sites"}
exp_browns_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(browns +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "Brown algae") + 
    scale_fill_manual(values = cols) +
  theme(legend.position = "none")

 ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(browns +1), fill = region)) +
  labs(y = "Brown algae abundance (log (% cover + 1))", x = "treatment") + 
    scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_brownalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```


##### Diatoms
Only 2 sites have diatoms so not doing anything with this at the moment.  
```{R Experiment Diatoms}
exp_data %>% filter(diatom_pt > 0) %>% group_by(site) %>% tally()

```

```{R Experiment algae by taxonomy plot and anova table}
exp_taxonomic_algae_plot <- plot_grid(exp_browns_plot, exp_greens_plot, exp_reds_plot, nrow = 1, ncol = 3)

ggsave(here::here("figures", "exp_taxonomic_algae_plot.png"), plot = exp_taxonomic_algae_plot, device = png, width = 12, height = 8)

exp_algae_taxonomy_anova_table <- rbind(exp_brown_anova_table, exp_green_anova_table, exp_red_anova_table)

exp_algae_taxonomy_anova_table <- exp_algae_taxonomy_anova_table %>% 
  filter(term != "(Intercept)") %>% 
  dplyr::rename(source = term)

write_csv(exp_algae_taxonomy_anova_table, here::here("results", "exp_algae_taxonomy_anova_table.csv"))
```

#### Functional groupings

##### Grazed Algae
```{R Experiment grazed algae: plots}
hist(exp_data$grazed)

a <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = grazed))

b <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = grazed))

par(mfrow = c(1,2))
a + b

```

```{R Experiment grazed algae: models, echo = TRUE}
exp_grazed_poisson <- glmmTMB(round(grazed) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_grazed_NB <- update(exp_grazed_poisson, family = nbinom2) 

exp_grazed_NB1 <- update(exp_grazed_poisson, family = nbinom1) 

exp_grazed_gaussian <- glmmTMB((grazed+1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_grazed_tweedie <- glmmTMB(grazed ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) 

# models with zero-inflation
exp_grazed_zipoisson <- glmmTMB(round(grazed) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_grazed_ziNB <- update(exp_grazed_zipoisson, family = nbinom2) 

exp_grazed_ziNB1 <- update(exp_grazed_zipoisson, family = nbinom1) # best model 

```

Checking assumptions:  
```{R Experiment grazed algae: model selection and checking assumptions}
AICtab(exp_grazed_poisson ,exp_grazed_NB, exp_grazed_NB1, exp_grazed_gaussian, exp_grazed_tweedie, exp_grazed_ziNB, exp_grazed_ziNB1, exp_grazed_zipoisson)

#checking assumptions 
exp_grazed_sim_res <- simulateResiduals(exp_grazed_ziNB1)
plot(exp_grazed_sim_res) # unequal variance

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_grazed_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_grazed_sim_res, form = exp_data$region) # unequal variance
```  

Adding a dispersion formula for treatment*site  
```{R Experiment grazed algae: refining model}
#adding a dispersion formula
exp_grazed_ziNB1_2 <- glmmTMB(round(grazed) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, dispformula = ~treatment*site, family = nbinom1(link = "log"))

#checking assumptions 
set.seed(555)
exp_grazed_sim_res_2 <- simulateResiduals(exp_grazed_ziNB1_2)
plot(exp_grazed_sim_res_2) # good

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_grazed_sim_res_2, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_grazed_sim_res_2, form = exp_data$region) # good

```

Model outputs:  
```{R Experiment grazed algae: model outputs}

# parameters
coef <- summary(exp_grazed_ziNB1_2)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Grazed Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_grazed_ziNB1_2, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Grazed Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_grazed_anova_table <- car::Anova(exp_grazed_ziNB1_2, type = "III") %>% 
  tidy() 

grp_means_log <- emmeans(exp_grazed_ziNB1_2, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Grazed Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)

```


```{R Experiment grazed algae: final plot}
exp_grazed_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(grazed +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "grazed algae") +
  scale_fill_manual(values = cols) + 
  ylim(0,5)

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(grazed +1), fill = region)) +
  labs(y = "grazed algae abundance (log (% cover + 1))", x = "treatment") +
  scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_grazedalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```


##### Nongrazed Algae 

```{R Experiment nongrazed algae: plots}
hist(exp_data$nongrazed)

a <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = nongrazed))

b <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = region, y = nongrazed))

par(mfrow = c(1, 2))
a + b
```

```{R Experiment nongrazed algae: models, echo = TRUE}
exp_nongrazed_poisson <- glmmTMB(round(nongrazed) ~ treatment * region +  (1|region/site), data = exp_data, family = poisson(link = "log"))

exp_nongrazed_NB <- update(exp_nongrazed_poisson, family = nbinom2) 

exp_nongrazed_NB1 <- update(exp_nongrazed_poisson, family = nbinom1) 

exp_nongrazed_gaussian <- glmmTMB((nongrazed+1) ~ treatment * region +  (1|region/site), data = exp_data, family = gaussian(link = "log"))

exp_nongrazed_tweedie <- glmmTMB(nongrazed ~ treatment * region +  (1|region/site), data = exp_data, family = tweedie(link = "log")) # best model 

# models with zero-inflation
exp_nongrazed_zipoisson <- glmmTMB(round(nongrazed) ~ treatment * region +  (1|region/site), data = exp_data, ziformula = ~1, family = poisson(link = "log"))

exp_nongrazed_ziNB <- update(exp_nongrazed_zipoisson, family = nbinom2) 

exp_nongrazed_ziNB1 <- update(exp_nongrazed_zipoisson, family = nbinom1) 

```

Checking model assumptions:  
```{R Experiment nongrazed algae: model selection and checking assumptions}
AICtab(exp_nongrazed_poisson, exp_nongrazed_NB, exp_nongrazed_NB1, exp_nongrazed_gaussian, exp_nongrazed_tweedie, exp_nongrazed_ziNB, exp_nongrazed_ziNB1, exp_nongrazed_zipoisson)

#checking assumptions 
set.seed(200)
exp_nongrazed_sim_res <- simulateResiduals(exp_nongrazed_tweedie)
plot(exp_nongrazed_sim_res) # good

par(mfrow = c(1,2))
# plot residuals against treatment
plotResiduals(exp_nongrazed_sim_res, form = exp_data$treatment) # good
# plot residuals against salinity region
plotResiduals(exp_nongrazed_sim_res, form = exp_data$region) # good

```

```{R Experiment nongrazed algae: model outputs}

# parameters
coef <- summary(exp_nongrazed_tweedie)$coefficients$cond

coef %>% 
  kableExtra::kable(caption = "coefficient estimates for model fitted to Non-grazed Algae field experiment data") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

car::Anova(exp_nongrazed_tweedie, type = "III") %>% 
  tidy() %>% 
  kableExtra::kable(caption = "p values for model fitted to Non-grazed Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

exp_nongrazed_anova_table <- car::Anova(exp_nongrazed_tweedie, type = "III") %>% 
  tidy() 

grp_means_log <- emmeans(exp_nongrazed_tweedie, specs = pairwise ~ treatment | region, data = exp_data)

pw <- as.data.frame(grp_means_log$contrasts)

pw %>%   
    kableExtra::kable(caption = "tukey adjusted p values for pairwise comparisons from model fitted to Non-grazed Algae field experiment data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  kableExtra::column_spec(1:7, color = "black", background = ifelse(pw$p.value < 0.05, "yellow", "white"))

plot(grp_means_log, comparison = TRUE)
```

```{R Experiment nongrazed algae: final plot}
exp_nongrazed_plot <- ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(nongrazed +1), fill = region)) +
  labs(y = "abundance (log (% cover + 1))", x = "treatment", title = "nongrazed algae") + 
  scale_fill_manual(values = cols) + 
  ylim(0,5)

ggplot(data = exp_data) + 
  geom_boxplot(aes(x = treatment, y = log(nongrazed +1), fill = region)) +
  labs(y = "nongrazed algae abundance (log (% cover + 1))", x = "treatment") + 
  scale_fill_manual(values = cols)

ggsave(here::here("figures", "exp_nongrazedalgae.png"), plot = last_plot(), device = png, width = 12, height = 8, units = "cm")
```

```{R Experiment algae by functional group plot}
exp_functional_algae_plot <- plot_grid(exp_grazed_plot, exp_nongrazed_plot)

ggsave(here::here("figures", "exp_functional_algae_plot.png"), plot = exp_functional_algae_plot, device = png, width = 12, height = 8)

exp_algae_function_anova_table <- rbind(exp_grazed_anova_table,  exp_nongrazed_anova_table)

exp_algae_function_anova_table <- exp_algae_function_anova_table %>% 
  filter(term != "(Intercept)") %>% 
  dplyr::rename(source = term)

write_csv(exp_algae_function_anova_table, here::here("results", "exp_algae_function_anova_table.csv"))
```
## Summary for all models: 

```{R Survey: Model Summaries}

df <- data.frame(species  = c("limpets", "littorines", "balanus", "chthamalus", "red algae", "green algae", "brown algae", "grazed", "nongrazed"),
                 distribution_family = c("negative binomial 1", "negative binomial 1", "negative binomial 1", "negative binomial 2", "negative binomial 1", "negative binomial 1", "negative binomial 1", "negative binomial 2", "negative binomial 1"),
                  zero_inflated = c("yes", "no", "no", "no", "no", "no", "no", "no", "no"),
                  dispersion_formula = c("n/a", "salinity*month", "salinity*month", "salinity", "site", "n/a", "site", "n/a", "site"),
                  month = c("yes", "no", "yes", "yes", "no", "yes", "yes", "yes", "yes"),
                  region = c("yes", "no", "yes", "yes", "yes", "yes", "no", "no", "no"),
                  month_region = c("yes", "no", "yes", "yes", "no", "yes", "no", "yes", "no"))

df %>%   
    kableExtra::kable(caption = "Model descriptions for survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) %>% 
  kableExtra::column_spec(5, color = "black", background = ifelse(df$month == "yes", "pink", "white")) %>% 
    kableExtra::column_spec(6, color = "black", background = ifelse(df$region == "yes", "pink", "white")) %>% 
    kableExtra::column_spec(7, color = "black", background = ifelse(df$month_region == "yes", "pink", "white"))

```

```{R Experiment: Model Summaries}
df <- data.frame(species  = c("balanus", "chthamalus", "all algae", "red algae", "green algae", "brown algae", "grazed", "nongrazed"),
                 distribution_family = c("tweedie", "negative binomial 1", "negative binomial 1", "tweedie", "negative binomial 1", "tweedie", "negative binomial 1", "tweedie"),
                  zero_inflated = c("no", "yes", "yes", "no", "yes", "no", "yes", "no"),
                  dispersion_formula = c("treatment*site", "n/a", "region", "n/a", "region", "n/a", "treatment*site", "n/a"),
                  treatment = c("yes", "yes", "yes", "no", "no", "no", "no", "no"),
                  region = c("yes (site)", "yes", "yes", "no", "yes", "no", "yes", "no"),
                  treatment_region = c("yes", "yes", "yes", "no", "no", "no", "no", "no"))

df %>%   
    kableExtra::kable(caption = "Model descriptions for survey data") %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) %>% 
  kableExtra::column_spec(5, color = "black", background = ifelse(df$treatment == "yes", "pink", "white")) %>% 
    kableExtra::column_spec(6, color = "black", background = ifelse(df$region == "yes", "pink", "white")) %>% 
    kableExtra::column_spec(7, color = "black", background = ifelse(df$treatment_region == "yes", "pink", "white"))
```
